{% extends 'base.html' %}

{% block page_title %}Dashboard{% endblock %}

{% block title %}{{ config.company_name }} Roadmap - Dashboard{% endblock %}

{% block content %}
<div class="welcome-banner">
  <h2><img src="{{ url_for('static', filename='./icons/cycle.svg')}}" style="max-height:20px; margin-right:10px;">Kick off a Cycle</h2>
  <p>This is your planning area. Move projects from the discussion area into the sprint or into the backlog.</p>
</div>

<!-- ---------------------------------- -->
<!-- Break -->
<!-- ---------------------------------- -->

<div style="width:100%; border-bottom:1px solid #e4e6eb;margin-bottom:20px;padding: 0px 20px;">
  <h2>Select Cycle</h2>
</div>

<!-- ---------------------------------- -->
<!-- Select a Cycle -->
<!-- ---------------------------------- -->

<section class="section cycle-section">
  <div class="section-header collapsible-header" onclick="toggleCycleSection()">
    <h3>Select Sprint</h3>
  </div>

  <div style="padding:20px;">
    <h4>CURRENTLY PLANNING FOR:</h4>
    <p>{{ selectedsprint.title }} ( {{selectedsprint.date_start.strftime('%b %d, %Y')}} - {{selectedsprint.date_end.strftime('%b %d, %Y')}})</p>
    <p><button id="toggleSelectSprint">Change</button>
    </p>
  </div>

  <div class="sprint-selection-option" style="display:none; padding:20px;">
    <h4>SELECT SPRINT</h4>
    <form id="select-sprint-form">
      <select id="sprint-dropdown" name="sprint_id" class="form-control" style="height:100%;">
        {% for sprint in sprints %}
        <option value="{{ sprint.id }}">{{ sprint.title }} ({{ sprint.date_start.strftime('%b %d') }} - {{ sprint.date_end.strftime('%b %d, %Y') }})</option>
        {% endfor %}
        <option value="new">-- Create a New Sprint --</option>
      </select>
      <button type="submit" id="select-dropdown-sprint" class="btn-secondary">Select</button>
    </form>
  </div>

  <!-- Sprint creation form (hidden by default) -->
  <div id="create-sprint-form" class="sprint-creation-form" style="display: none;">
    <form id="sprint-form" method="POST" action="{{ url_for('planningStep2CycleCreation') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <div class="form-group">
        <label for="title">Sprint Title</label>
        <input type="text" id="title" name="title" class="form-control" required>
      </div>
      <div class="form-group">
        <label for="date_start">Start Date</label>
        <input type="date" id="date_start" name="date_start" class="form-control" required>
      </div>
      <div class="form-group">
        <label for="date_end">End Date</label>
        <input type="date" id="date_end" name="date_end" class="form-control" required>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-primary">Create & Select</button>
        <button type="button" id="cancel-create" class="btn-text">Cancel</button>
      </div>
    </form>
  </div>

</section>

<!-- ---------------------------------- -->
<!-- Break -->
<!-- ---------------------------------- -->

<div style="width:100%; border-bottom:1px solid #e4e6eb;margin-bottom:20px;padding: 0px 20px;">
  <h2>Projects and Objectives</h2>
</div>

<!-- ---------------------------------- -->
<!-- Discussion List -->
<!-- ---------------------------------- -->

<section class="two-column-section">

  <!-- Wide Column -->
  <section class="section discussion-section column-wide section">
    <div class="section-header collapsible-header" onclick="toggleDiscussionSection()">
      <h3>Projects Under Discussion <span style="color:gray; font-weight:200;">({{ projects|selectattr('location', '==', "discussion")|list|length }})</span></h3>
      <div class="header-actions">
        <a href="{{ url_for('createProject') }}" class="btn-icon" title="Add new Goal">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </a>
        <span class="collapse-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </span>
      </div>
    </div>

    <div class="discussion-list" id="discussion-list">
      {% for project in projects|selectattr('location', '==', "discussion")|list %}
      <div class="discussion-item" data-project-id="{{ project.id }}">
        <p><strong>{{ project.name }}</strong><br>
          <span class="discussion-details">{{ project.context }}</span>
        </p>
        <div class="discussion-actions">
          <span class="requester date-badge">{{ project.dri }}</span> <span class="date-badge">{{ project.created.strftime('%b %d, %Y') }}</span>
          <button class="btn-text discuss-btn" data-project-id="{{ project.id }}">Discuss</button>
          <a href="{{ url_for('edit', project_id=project.id) }}" class="btn-icon" title="Edit project"><button class="btn-text">Edit</button></a>
          <button class="btn-text add-to-cycle-btn" data-project-id="{{ project.id }}">Commit to Sprint</button>
          <button class="btn-text move-to-backlog-btn" data-project-id="{{ project.id }}">Move to Backlog</button>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>

  <!-- Narrow Column -->
  <section class="section discussion-section column-narrow section">
    <div class="section-header">
      <h3>Active Objectives</h3>
      <a href="{{ url_for('createGoal') }}" class="btn-icon" title="Add new Goal">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </a>
    </div>
    <div class="goals-list">
    {% for goal_data in goals %}
    <div class="goal-item">
      <h4 style="display:flex; justify-content: space-between;">
        {{ goal_data.Goal.title }}
        <span class='project-count-badge {% if goal_data.sprint_project_count == 0 %}' style='background-color:#a10000; color:white;{% endif %}'>
          {{ goal_data.sprint_project_count }} commitment{% if goal_data.sprint_project_count != 1 %}s{% endif %}
        </span>
      </h4>
      <p>{{ goal_data.Goal.details }}</p>
    </div>
    {% endfor %}
  </div>
  </section>

</section>


<!-- ---------------------------------- -->
<!-- Break -->
<!-- ---------------------------------- -->

<div style="width:100%; border-bottom:1px solid #e4e6eb;margin-bottom:20px;padding: 0px 20px;">
  <h2>Commitment Details</h2>
</div>

<!-- ------------------------------ -->
<!-- Cycle Commitments -->
<!-- ------------------------------ -->

<section>

  <div class="section">

    <div class="section-header">
      <h3>Cycle Commitments</h3>
      <span class="status-badge status-planned">
        {% if sprints|length > 0 %}
        {{ sprints[0].date_start.strftime('%b %d, %Y') }} &rarr; {{ sprints[0].date_end.strftime('%b %d, %Y') }}
        {% endif %}
      </span>
    </div>

    <div class="sprint-projects sortable-projects" id="sortable-projects">
      {% for entry in sprintlog %}
      {% set project = entry.project %}
      <div class="project-item" data-id="{{ entry.id }}" data-project-id="{{ project.id }}" data-order="{{ entry.order }}" style="display:flex; flex-direction: row;">

        {# Handle, Column 1 #}
        <div class="project-handle" style="flex-shrink:1; text-align:center;">
          <span class="drag-handle">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="9" cy="5" r="1"></circle>
              <circle cx="9" cy="12" r="1"></circle>
              <circle cx="9" cy="19" r="1"></circle>
              <circle cx="16" cy="5" r="1"></circle>
              <circle cx="16" cy="12" r="1"></circle>
              <circle cx="16" cy="19" r="1"></circle>
            </svg>
          </span>
        </div>

        {# Body, Column 2 #}
        <div class="project-body" style="flex-grow:12;">
          <div class="project-header">
            <h4>
              {{ project.name }}
            </h4>
          </div>
          <div class="project-meta">
            <p><strong>Priority:</strong> {{ entry.order }}<br>
              <strong>Goal:</strong> {{ entry.goal }}
              <br><strong>Lead:</strong> <span class="project-team">{{ project.dri }} / {{ project.team }}</span>
            </p>
            <div class="commitments-actions">
              <a href="{{ url_for('project', project_id=project.id) }}"><button class="btn-text">Go To Project</button></a>
              <button class="btn-text quickview-btn" data-project-id="{{ project.id }}">Quick View</button>
              <button class="btn-text edit-goal-btn" data-project-id="{{ project.id }}" data-sprint-project-id="{{ entry.id }}" data-goal="{{ entry.goal }}">Edit Commitment Goal</button>
              <button class="btn-text move-to-discussion-btn" data-project-id="{{ project.id }}">Send to Discussion</button>
              <button class="btn-text move-to-backlog-btn" data-project-id="{{ project.id }}">Send to Backlog</button>
            </div>
          </div>
        </div>

        {# Column 3, Statuses #}
        <div class="project-status" style="display:flex; flex-direction:column; flex-shrink:1;">
            <span class="status-badge 
            {% if entry.status == 'In Progress' %}status-in-progress
            {% elif entry.status == 'Done' %}status-complete
            {% elif entry.status == 'Blocked' %}status-blocked
            {% else %}status-planned{% endif %}">
              {{ entry.status|default('Planned') }}
            </span>
            {% if entry.critical %}
            <span class="status-badge critical" data-id="{{ entry.id }}" title="Toggle critical status">Critical</span>
            {% else %}
            <span class="status-badge not-critical" data-id="{{ entry.id }}" title="Toggle critical status">Not Critical</span>
            {% endif %}
        </div>

      </div>
      {% endfor %}
    </div>
</section>

<!-- ---------------------------------- -->
<!-- Break -->
<!-- ---------------------------------- -->

<div style="width:100%; border-bottom:1px solid #e4e6eb;margin-bottom:20px;padding: 0px 20px;">
  <h2>Save and Communicate</h2>
</div>

<!-- Project Details Modal -->
<div id="projectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-title">Project Details</h3>
      <span class="close-modal">&times;</span>
    </div>
    <div class="modal-body">
      <div class="project-info">
        <div class="info-group">
          <label>Title:</label>
          <p id="modal-project-title"></p>
        </div>
        <div class="info-group">
          <label>Details:</label>
          <p id="modal-project-details"></p>
        </div>
        <div class="info-group">
          <label>Context:</label>
          <p id="modal-project-context"></p>
        </div>
        <div class="info-group">
          <label>Requirements:</label>
          <p id="modal-project-requirements"></p>
        </div>
        <div class="info-group">
          <label>DRI:</label>
          <p id="modal-project-dri"></p>
        </div>
        <div class="info-group">
          <label>Created:</label>
          <p id="modal-project-created"></p>
        </div>
      </div>

      <!-- Sprint Goal Input (hidden by default) -->
      <div id="sprint-goal-container" class="sprint-goal-container" style="display: none;">
        <label for="sprint-goal">Sprint Goal:</label>
        <textarea id="sprint-goal" class="form-control" rows="3" placeholder="Define the sprint goal for this project"></textarea>
        <input type="hidden" id="sprint-project-id" value="">
      </div>
    </div>
    <div class="modal-footer">
      <div id="standard-actions">
        <button id="btn-edit" class="btn btn-secondary">Edit</button>
        <button id="btn-move-backlog" class="btn btn-secondary">Move to Backlog</button>
        <button id="btn-move-discussion" class="btn btn-secondary" style="display: none;">Move to Discussion</button>
        <button id="btn-move-sprint" class="btn btn-primary">Move to Sprint</button>
      </div>
      <div id="edit-goal-actions" style="display: none;">
        <button id="btn-update-goal" class="btn btn-success">Update Goal</button>
        <button id="btn-cancel-goal-edit" class="btn btn-text">Cancel</button>
      </div>
      <div id="add-to-sprint-actions" style="display: none;">
        <button id="btn-confirm-sprint" class="btn btn-success">Confirm</button>
        <button id="btn-cancel" class="btn btn-text">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Simple notification function implementation
  function showNotification(message, type) {
    console.log(`${type.toUpperCase()}: ${message}`);
    // You can implement a more visual notification here if needed
  }

  // Handle the dropdown selection and form submission
  const selectSprintForm = document.getElementById('select-sprint-form');
  const sprintDropdown = document.getElementById('sprint-dropdown');
  const createSprintForm = document.getElementById('create-sprint-form');
  const cancelCreateBtn = document.getElementById('cancel-create');

  // Handle the select sprint form submission
  if (selectSprintForm) {
    selectSprintForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const selectedValue = sprintDropdown.value;

      if (selectedValue === 'new') {
        // Show the create sprint form if "Create a New Sprint" is selected
        createSprintForm.style.display = 'block';
      } else {
        // Build the URL dynamically based on the selected sprint ID
        const baseUrl = window.location.pathname.split('/').slice(0, -1).join('/');
        window.location.href = baseUrl + '/' + selectedValue;
      }
    });
  }

  // Handle the cancel button click
  if (cancelCreateBtn) {
    cancelCreateBtn.addEventListener('click', function() {
      createSprintForm.style.display = 'none';
    });
  }
  
  // Modal functionality
  const modal = document.getElementById('projectModal');
  const closeModalBtn = document.querySelector('.close-modal');
  
  // Set up event listeners for discuss buttons
  document.querySelectorAll('.discuss-btn').forEach(button => {
    button.addEventListener('click', function() {
      const projectId = this.getAttribute('data-project-id');
      openProjectModal(projectId, 'discuss');
    });
  });
  
  // Set up event listeners for quickview buttons
  document.querySelectorAll('.quickview-btn').forEach(button => {
    button.addEventListener('click', function() {
      const projectId = this.getAttribute('data-project-id');
      openProjectModal(projectId, 'quickview');
    });
  });
  
  // Set up event listeners for "add to cycle" buttons
  document.querySelectorAll('.add-to-cycle-btn').forEach(button => {
    button.addEventListener('click', function() {
      const projectId = this.getAttribute('data-project-id');
      openProjectModal(projectId, 'add-to-cycle');
    });
  });
  
  // Set up event listeners for "edit goal" buttons
  document.querySelectorAll('.edit-goal-btn').forEach(button => {
    button.addEventListener('click', function() {
      const projectId = this.getAttribute('data-project-id');
      const sprintProjectId = this.getAttribute('data-sprint-project-id');
      const currentGoal = this.getAttribute('data-goal');
      openProjectModal(projectId, 'edit-goal', { sprintProjectId, currentGoal });
    });
  });
  
  // Set up event listeners for "move to backlog" buttons
  document.querySelectorAll('.move-to-backlog-btn').forEach(button => {
    button.addEventListener('click', function() {
      const projectId = this.getAttribute('data-project-id');
      moveProjectToBacklog(projectId);
    });
  });
  
  // Set up event listeners for "move to discussion" buttons
  document.querySelectorAll('.move-to-discussion-btn').forEach(button => {
    button.addEventListener('click', function() {
      const projectId = this.getAttribute('data-project-id');
      moveProjectToDiscussion(projectId);
    });
  });

  // Close modal when clicking the Ã— button
  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', function() {
      closeModal();
    });
  }

  // Close modal when clicking outside the modal
  if (modal) {
    window.addEventListener('click', function(event) {
      if (event.target === modal) {
        closeModal();
      }
    });
  }

  // Handle "Move to Sprint" button
  const moveToSprintBtn = document.getElementById('btn-move-sprint');
  const confirmSprintBtn = document.getElementById('btn-confirm-sprint');
  const cancelBtn = document.getElementById('btn-cancel');
  const sprintGoalContainer = document.getElementById('sprint-goal-container');
  const standardActions = document.getElementById('standard-actions');
  const addToSprintActions = document.getElementById('add-to-sprint-actions');
  const editGoalActions = document.getElementById('edit-goal-actions');
  
  // Move to Sprint button
  if (moveToSprintBtn) {
    moveToSprintBtn.addEventListener('click', function() {
      // Show sprint goal input and confirm/cancel buttons
      sprintGoalContainer.style.display = 'block';
      standardActions.style.display = 'none';
      addToSprintActions.style.display = 'block';
    });
  }

  // Cancel button for sprint goal
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function() {
      resetModalButtons();
    });
  }

  // Confirm Sprint button
  if (confirmSprintBtn) {
    confirmSprintBtn.addEventListener('click', function() {
      const projectId = modal.dataset.projectId;
      const sprintGoal = document.getElementById('sprint-goal').value;

      if (!sprintGoal.trim()) {
        alert('Please enter a sprint goal before confirming.');
        return;
      }

      // Submit the data to move the project to sprint
      moveProjectToSprint(projectId, sprintGoal);
    });
  }
  
  // Edit Project button
  const btnEdit = document.getElementById('btn-edit');
  if (btnEdit) {
    btnEdit.addEventListener('click', function() {
      const projectId = modal.dataset.projectId;
      window.location.href = `/project/${projectId}/edit/`;
    });
  }

  // Move to Backlog button
  const btnMoveBacklog = document.getElementById('btn-move-backlog');
  if (btnMoveBacklog) {
    btnMoveBacklog.addEventListener('click', function() {
      const projectId = modal.dataset.projectId;
      moveProjectToBacklog(projectId);
    });
  }
  
  // Move to Discussion button
  const btnMoveDiscussion = document.getElementById('btn-move-discussion');
  if (btnMoveDiscussion) {
    btnMoveDiscussion.addEventListener('click', function() {
      const projectId = modal.dataset.projectId;
      moveProjectToDiscussion(projectId);
    });
  }
  
  // Update Goal button
  const btnUpdateGoal = document.getElementById('btn-update-goal');
  if (btnUpdateGoal) {
    btnUpdateGoal.addEventListener('click', function() {
      const projectId = modal.dataset.projectId;
      const sprintProjectId = document.getElementById('sprint-project-id').value;
      const sprintGoal = document.getElementById('sprint-goal').value;
      
      if (!sprintGoal.trim()) {
        alert('Please enter a sprint goal before confirming.');
        return;
      }
      
      updateProjectGoal(projectId, sprintProjectId, sprintGoal);
    });
  }
  
  // Cancel Goal Edit button
  const btnCancelGoalEdit = document.getElementById('btn-cancel-goal-edit');
  if (btnCancelGoalEdit) {
    btnCancelGoalEdit.addEventListener('click', function() {
      resetModalButtons();
    });
  }

  // Function to toggle critical status UI
  function updateCriticalUI(badge, isCritical) {
    if (isCritical) {
      badge.textContent = 'Critical';
      badge.className = 'status-badge critical';
    } else {
      badge.textContent = 'Not Critical';
      badge.className = 'status-badge not-critical';
    }
  }

  // Add event listeners for critical status badges
  const criticalBadges = document.querySelectorAll('.status-badge.critical, .status-badge.not-critical');
  criticalBadges.forEach(badge => {
    badge.addEventListener('click', function() {
      const id = this.dataset.id;
      const isCritical = this.classList.contains('critical') && !this.classList.contains('not-critical');
      const newCriticalState = !isCritical;

      // Store original state in case we need to revert
      const originalState = isCritical;
      
      // Update UI immediately for better user experience
      updateCriticalUI(this, newCriticalState);

      // Send the update to the server
      fetch('/api/project/toggle_critical', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            sprintProjectId: id,
            critical: newCriticalState
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showNotification(
              newCriticalState ? 'Project marked as critical' : 'Project unmarked as critical',
              'success'
            );
          } else {
            // Revert the visual change if the server update failed
            updateCriticalUI(this, originalState);
            showNotification('Failed to update project status', 'error');
          }
        })
        .catch(error => {
          console.error('Error updating critical status:', error);
          // Revert the visual change if there was an error
          updateCriticalUI(this, originalState);
          showNotification('Error updating project status', 'error');
        });
    });
  });

  // Initialize Sortable for project reordering
  const projectsList = document.getElementById('sortable-projects');
  if (projectsList && projectsList.children.length > 0 && typeof Sortable !== 'undefined') {
    const sortable = new Sortable(projectsList, {
      animation: 150,
      handle: '.drag-handle',
      ghostClass: 'sortable-ghost',
      chosenClass: 'sortable-chosen',
      onEnd: function(evt) {
        updateProjectOrder();
      }
    });

    // Function to get all projects and their new order
    function updateProjectOrder() {
      const projects = document.querySelectorAll('#sortable-projects .project-item');
      const orderData = [];

      projects.forEach((project, index) => {
        orderData.push({
          id: project.dataset.id,
          order: index + 1
        });
      });

      // Send the new order to the server
      fetch('/api/projects/reorder', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            projects: orderData
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showNotification('Project order updated successfully', 'success');
          } else {
            showNotification('Failed to update project order', 'error');
          }
        })
        .catch(error => {
          console.error('Error updating project order:', error);
          showNotification('Error updating project order', 'error');
        });
    }
  }

  // Get references to the button and div elements for sprint toggle
  const toggleButton = document.getElementById('toggleSelectSprint');
  const sprintSelectionDiv = document.querySelector('.sprint-selection-option');

  // Add click event listener to the sprint toggle button
  if (toggleButton && sprintSelectionDiv) {
    toggleButton.addEventListener('click', function() {
      // Toggle the display property of the div
      if (sprintSelectionDiv.style.display === 'none') {
        sprintSelectionDiv.style.display = 'block';
      } else {
        sprintSelectionDiv.style.display = 'none';
      }
    });
  }
});

// Function to open the modal and load project details
function openProjectModal(projectId, mode, options = {}) {
  const modal = document.getElementById('projectModal');
  if (!modal) return;
  
  modal.dataset.projectId = projectId;

  // Reset the modal to default state first
  resetModalButtons();
  
  // Configure modal based on mode
  if (mode === 'edit-goal') {
    document.getElementById('modal-title').textContent = "Edit Sprint Goal";
    document.getElementById('sprint-goal-container').style.display = 'block';
    document.getElementById('sprint-goal').value = options.currentGoal || '';
    document.getElementById('sprint-project-id').value = options.sprintProjectId || '';
    document.getElementById('standard-actions').style.display = 'none';
    document.getElementById('edit-goal-actions').style.display = 'block'; 
  } else if (mode === 'add-to-cycle') {
    document.getElementById('modal-title').textContent = "Add to Sprint";
    document.getElementById('sprint-goal-container').style.display = 'block';
    document.getElementById('standard-actions').style.display = 'none';
    document.getElementById('add-to-sprint-actions').style.display = 'block';
  } else if (mode === 'quickview') {
    document.getElementById('modal-title').textContent = "Project Quick View";
    document.getElementById('btn-move-discussion').style.display = 'inline-block';
  } else {
    document.getElementById('modal-title').textContent = "Project Details";
  }

  // Show the modal
  modal.style.display = 'block';

  // Fetch project details via AJAX
  fetchProjectDetails(projectId);
}

// Function to close the modal
function closeModal() {
  const modal = document.getElementById('projectModal');
  if (!modal) return;
  
  modal.style.display = 'none';
  resetModalButtons();

  // Clear the sprint goal input
  const sprintGoal = document.getElementById('sprint-goal');
  const sprintProjectId = document.getElementById('sprint-project-id');
  
  if (sprintGoal) sprintGoal.value = '';
  if (sprintProjectId) sprintProjectId.value = '';
}

// Reset modal buttons to their default state
function resetModalButtons() {
  const sprintGoalContainer = document.getElementById('sprint-goal-container');
  const standardActions = document.getElementById('standard-actions');
  const addToSprintActions = document.getElementById('add-to-sprint-actions');
  const editGoalActions = document.getElementById('edit-goal-actions');
  const btnMoveDiscussion = document.getElementById('btn-move-discussion');
  
  if (sprintGoalContainer) sprintGoalContainer.style.display = 'none';
  if (standardActions) standardActions.style.display = 'block';
  if (addToSprintActions) addToSprintActions.style.display = 'none';
  if (editGoalActions) editGoalActions.style.display = 'none';
  if (btnMoveDiscussion) btnMoveDiscussion.style.display = 'none';
}

// Function to fetch project details from server
function fetchProjectDetails(projectId) {
  fetch(`/api/project/${projectId}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(project => {
      // Populate modal with project details
      const modalTitle = document.getElementById('modal-project-title');
      const modalDetails = document.getElementById('modal-project-details');
      const modalContext = document.getElementById('modal-project-context');
      const modalRequirements = document.getElementById('modal-project-requirements');
      const modalDri = document.getElementById('modal-project-dri');
      const modalCreated = document.getElementById('modal-project-created');
      const btnMoveDiscussion = document.getElementById('btn-move-discussion');
      
      if (modalTitle) modalTitle.textContent = project.name;
      if (modalDetails) modalDetails.textContent = project.details || 'No details provided';
      if (modalContext) modalContext.textContent = project.context || 'No context provided';
      if (modalRequirements) modalRequirements.textContent = project.requirements || 'No requirements specified';
      if (modalDri) modalDri.textContent = project.dri || 'Unassigned';
      if (modalCreated) modalCreated.textContent = project.created || '';
      
      // Show/hide move to discussion button based on location
      if (project.location === 'sprint' && btnMoveDiscussion) {
        btnMoveDiscussion.style.display = 'inline-block';
      }
    })
    .catch(error => {
      console.error('Error fetching project details:', error);
      alert('Failed to load project details. Please try again.');
      closeModal();
    });
}

// Function to move project to sprint
function moveProjectToSprint(projectId, sprintGoal) {
  const selectedSprintId = typeof selectedsprint !== 'undefined' ? selectedsprint.id : null;
  
  if (!selectedSprintId) {
    console.error('Selected sprint ID is not available');
    alert('Error: Could not determine the current sprint.');
    return;
  }
  
  fetch('/api/project/commit_to_sprint', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        projectId: projectId,
        sprintId: selectedSprintId,
        goal: sprintGoal
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(result => {
      if (result.success) {
        // Close the modal and refresh the page to show updated data
        closeModal();
        window.location.reload();
      } else {
        alert(result.message || 'Failed to move project to sprint.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while processing your request.');
    });
}

// Function to move project to backlog
function moveProjectToBacklog(projectId) {
  const data = {
    projectId: projectId,
    location: 'backlog'
  };

  fetch('/api/project/move', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(result => {
      if (result.success) {
        // Close the modal and refresh the page to show updated data
        closeModal();
        window.location.reload();
      } else {
        alert(result.message || 'Failed to move project to backlog.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while processing your request.');
    });
}

// Function to move project to discussion
function moveProjectToDiscussion(projectId) {
  const data = {
    projectId: projectId,
    location: 'discussion'
  };

  fetch('/api/project/move', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(result => {
      if (result.success) {
        // Close the modal and refresh the page to show updated data
        closeModal();
        window.location.reload();
      } else {
        alert(result.message || 'Failed to move project to discussion.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while processing your request.');
    });
}

// Function to update project sprint goal
function updateProjectGoal(projectId, sprintProjectId, sprintGoal) {
  const selectedSprintId = typeof selectedsprint !== 'undefined' ? selectedsprint.id : null;
  
  if (!selectedSprintId) {
    console.error('Selected sprint ID is not available');
    alert('Error: Could not determine the current sprint.');
    return;
  }
  
  fetch('/api/project/commit_to_sprint', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        projectId: projectId,
        sprintId: selectedSprintId,
        goal: sprintGoal,
        sprintProjectId: sprintProjectId
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(result => {
      if (result.success) {
        // Close the modal and refresh the page to show updated data
        closeModal();
        window.location.reload();
      } else {
        alert(result.message || 'Failed to update sprint goal.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while processing your request.');
    });
}
</script>

{% include './js/sortable.html' %}

<!-- Sprint Closeout Section -->
<div style="width:100%; border-bottom:1px solid #e4e6eb;margin-bottom:20px;padding: 0px 20px;">
  <h2>Finalize Sprint Planning</h2>
</div>

<section class="two-column-section">
  <!-- Column 1: Sprint Analytics -->
  <div class="column-wide section">
    <div class="section-header">
      <h3>Sprint Analytics</h3>
    </div>
    <div class="analytics-container" style="padding: 20px;">
      <div class="analytics-row" style="display: flex; margin-bottom: 20px;">
        <!-- Projects Count Card -->
        <div class="analytics-card" style="flex: 1; background-color: #f8f9fa; border-radius: 8px; padding: 16px; margin-right: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <div class="analytics-value" style="font-size: 28px; font-weight: 700; color: #3e63dd;">{{ sprintlog|length }}</div>
          <div class="analytics-label" style="font-size: 14px; color: #6b7280;">Total Projects</div>
        </div>
        
        <!-- Objectives Count Card -->
        <div class="analytics-card" style="flex: 1; background-color: #f8f9fa; border-radius: 8px; padding: 16px; margin-right: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          {% set objective_count = sprintlog|map(attribute='project')|map(attribute='objective_id')|select('defined')|unique|list|length %}
          <div class="analytics-value" style="font-size: 28px; font-weight: 700; color: #10b981;">{{ objective_count }}</div>
          <div class="analytics-label" style="font-size: 14px; color: #6b7280;">Objectives Supported</div>
        </div>
        
        <!-- Critical Projects Card -->
        <div class="analytics-card" style="flex: 1; background-color: #f8f9fa; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          {% set critical_count = sprintlog|selectattr('critical', 'eq', true)|list|length %}
          <div class="analytics-value" style="font-size: 28px; font-weight: 700; color: #f59e0b;">{{ critical_count }}</div>
          <div class="analytics-label" style="font-size: 14px; color: #6b7280;">Critical Projects</div>
        </div>
      </div>
      
      <!-- Team Breakdown -->
      <div class="analytics-section" style="margin-bottom: 24px;">
        <h4 style="margin-bottom: 12px;">Projects by Team</h4>
        <div class="team-breakdown">
          {% set teams = {} %}
          {% for entry in sprintlog %}
            {% set team = entry.project.team %}
            {% if team in teams %}
              {% set _ = teams.update({team: teams[team] + 1}) %}
            {% else %}
              {% set _ = teams.update({team: 1}) %}
            {% endif %}
          {% endfor %}
          
          {% for team, count in teams.items() %}
            <div class="team-item" style="display: flex; align-items: center; margin-bottom: 8px;">
              <div class="team-name" style="flex: 1;">{{ team }}</div>
              <div class="team-count" style="width: 40px; text-align: right; font-weight: 600;">{{ count }}</div>
              <div class="team-bar" style="flex: 2; margin-left: 12px;">
                <div class="progress-bar" style="height: 8px; background-color: #e5e7eb; border-radius: 4px;">
                  <div class="progress-value" style="height: 100%; background-color: #3e63dd; border-radius: 4px; width: {{ (count / sprintlog|length) * 100 }}%;"></div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      
      <!-- DRI Breakdown -->
      <div class="analytics-section" style="margin-bottom: 24px;">
        <h4 style="margin-bottom: 12px;">Projects by DRI</h4>
        <div class="dri-breakdown">
          {% set dris = {} %}
          {% for entry in sprintlog %}
            {% set dri = entry.project.dri %}
            {% if dri in dris %}
              {% set _ = dris.update({dri: dris[dri] + 1}) %}
            {% else %}
              {% set _ = dris.update({dri: 1}) %}
            {% endif %}
          {% endfor %}
          
          {% for dri, count in dris.items() %}
            <div class="dri-item" style="display: flex; align-items: center; margin-bottom: 8px;">
              <div class="dri-name" style="flex: 1;">{{ dri }}</div>
              <div class="dri-count" style="width: 40px; text-align: right; font-weight: 600;">{{ count }}</div>
              <div class="dri-bar" style="flex: 2; margin-left: 12px;">
                <div class="progress-bar" style="height: 8px; background-color: #e5e7eb; border-radius: 4px;">
                  <div class="progress-value" style="height: 100%; background-color: #10b981; border-radius: 4px; width: {{ (count / sprintlog|length) * 100 }}%;"></div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  
  <!-- Column 2: Activate Sprint -->
  <div class="column-narrow section">
    <div class="section-header">
      <h3>Activate Sprint</h3>
    </div>
    <div style="padding: 20px;">
      <div class="sprint-summary" style="background-color: #f3f4f6; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
        <h4 style="margin-top: 0; margin-bottom: 12px;">{{ selectedsprint.title }}</h4>
        <p style="margin-bottom: 8px;">
          <strong>Timeline:</strong> {{ selectedsprint.date_start.strftime('%b %d, %Y') }} - {{ selectedsprint.date_end.strftime('%b %d, %Y') }}
        </p>
        <p style="margin-bottom: 8px;">
          <strong>Duration:</strong> {{ (selectedsprint.date_end - selectedsprint.date_start).days }} days
        </p>
        <p style="margin-bottom: 0;">
          <strong>Projects:</strong> {{ sprintlog|length }} total ({{ sprintlog|selectattr('critical', 'eq', true)|list|length }} critical)
        </p>
      </div>
      
      <form id="activate-sprint-form" action="/api/activate_sprint" method="POST">
        <input type="hidden" name="sprint_id" value="{{ selectedsprint.id }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        
        <div class="form-group" style="margin-bottom: 16px;">
          <div class="checkbox-wrapper" style="display: flex; align-items: center; margin-bottom: 16px;">
            <input type="checkbox" id="emailNotification" name="send_email" style="margin-right: 8px;">
            <label for="emailNotification">Send sprint email notification?</label>
          </div>
          
          <div id="emailFormGroup" style="display: none; margin-bottom: 16px;">
            <label for="emailAddresses" style="display: block; margin-bottom: 6px;">Email Recipients (comma-separated)</label>
            <input type="text" id="emailAddresses" name="email_addresses" class="form-control" placeholder="example@company.com, team@company.com">
            <small style="color: #6b7280; font-size: 12px;">Enter comma-separated email addresses to notify about this sprint</small>
          </div>
        </div>
        
        <div class="form-actions" style="display: flex; justify-content: space-between; align-items: center;">
          <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary" style="background-color: #3e63dd; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
            Save & Activate Sprint
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- JavaScript for email notification toggle -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const emailCheckbox = document.getElementById('emailNotification');
  const emailFormGroup = document.getElementById('emailFormGroup');
  
  emailCheckbox.addEventListener('change', function() {
    emailFormGroup.style.display = this.checked ? 'block' : 'none';
  });
  
  // Form submission handling
  const activateForm = document.getElementById('activate-sprint-form');
  
  activateForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(activateForm);
    
    fetch('/api/activate_sprint', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.href = data.redirect_url;
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while processing your request.');
    });
  });
});

document.addEventListener('DOMContentLoaded', function() {
  // Check email configuration status
  const emailCheckbox = document.getElementById('emailNotification');
  const emailFormGroup = document.getElementById('emailFormGroup');
  
  fetch('/api/check_email_config')
    .then(response => response.json())
    .then(data => {
      if (!data.configured) {
        // Disable checkbox if email is not configured
        emailCheckbox.disabled = true;
        emailCheckbox.checked = false;
        
        // Add a note about why it's disabled
        const noteElement = document.createElement('small');
        noteElement.style.color = '#dc3545';
        noteElement.style.display = 'block';
        noteElement.style.marginTop = '4px';
        noteElement.textContent = 'Email notifications are disabled. Configure email settings in the Settings page.';
        
        emailCheckbox.parentNode.appendChild(noteElement);
      }
    })
    .catch(error => {
      console.error('Error checking email configuration:', error);
    });
  
  emailCheckbox.addEventListener('change', function() {
    emailFormGroup.style.display = this.checked ? 'block' : 'none';
  });
});
</script>






{% endblock %}