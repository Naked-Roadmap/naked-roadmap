{% extends 'base.html' %}

{% block page_title %}Dashboard{% endblock %}

{% block title %}{{ config.company_name }} Roadmap - Dashboard{% endblock %}

{% block content %}
<div class="welcome-banner">
  <h2>Kick off a Cycle</h2>
  <p>This is your planning area. Move projects from the discussion area into the sprint or into the backlog.</p>
</div>

<!-- ---------------------------------- -->
<!-- Select a Cycle -->
<!-- ---------------------------------- -->

<section class="section cycle-section">
  <div class="section-header collapsible-header" style="display:flex; flex-direction:column; text-align:left;">
    <h4>CURRENTLY PLANNING FOR:</h4>
    <p>{{ selectedsprint.title }} ( {{selectedsprint.date_start.strftime('%b %d, %Y')}} - {{selectedsprint.date_end.strftime('%b %d, %Y')}})</p>
    <p><button id="toggleSelectSprint">Change</button>

    <div class="sprint-selection-option" style="display:none;">
      <h4>SELECT SPRINT</h4>
      <form id="select-sprint-form">
        <select id="sprint-dropdown" name="sprint_id" class="form-control" style="height:100%;">
          {% for sprint in sprints %}
          <option value="{{ sprint.id }}">{{ sprint.title }} ({{ sprint.date_start.strftime('%b %d') }} - {{ sprint.date_end.strftime('%b %d, %Y') }})</option>
          {% endfor %}
          <option value="new">-- Create a New Sprint --</option>
        </select>
        <button type="submit" id="select-dropdown-sprint" class="btn-secondary">Select</button>
      </form>
    </div>

    <!-- Sprint creation form (hidden by default) -->
    <div id="create-sprint-form" class="sprint-creation-form" style="display: none;">
      <form id="sprint-form" method="POST" action="{{ url_for('planningStep2CycleCreation') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
          <label for="title">Sprint Title</label>
          <input type="text" id="title" name="title" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="date_start">Start Date</label>
          <input type="date" id="date_start" name="date_start" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="date_end">End Date</label>
          <input type="date" id="date_end" name="date_end" class="form-control" required>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn-primary">Create & Select</button>
          <button type="button" id="cancel-create" class="btn-text">Cancel</button>
        </div>
      </form>
    </div>


  </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Handle the dropdown selection and form submission
      const selectSprintForm = document.getElementById('select-sprint-form');
      const sprintDropdown = document.getElementById('sprint-dropdown');
      const createSprintForm = document.getElementById('create-sprint-form');
      const createSprintBtn = document.getElementById('create-sprint-btn');
      const cancelCreateBtn = document.getElementById('cancel-create');

      // Handle the select sprint form submission
      selectSprintForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const selectedValue = sprintDropdown.value;

        if (selectedValue === 'new') {
          // Show the create sprint form if "Create a New Sprint" is selected
          createSprintForm.style.display = 'block';
        } else {
          // Build the URL dynamically based on the selected sprint ID
          const baseUrl = window.location.pathname.split('/').slice(0, -1).join('/');
          window.location.href = baseUrl + '/sprint/' + selectedValue;
        }
      });

      // Handle the "Create New Sprint" button click
      createSprintBtn.addEventListener('click', function() {
        createSprintForm.style.display = 'block';
      });

      // Handle the cancel button click
      cancelCreateBtn.addEventListener('click', function() {
        createSprintForm.style.display = 'none';
      });
    });

    // Handle the cancel button click
    cancelCreateBtn.addEventListener('click', function() {
    createSprintForm.style.display = 'none';
    });
    });
  </script>

  <script>
    // Get references to the button and div elements
    const toggleButton = document.getElementById('toggleSelectSprint');
    const sprintSelectionDiv = document.querySelector('.sprint-selection-option');

    // Add click event listener to the button
    toggleButton.addEventListener('click', function() {
      // Toggle the display property of the div
      if (sprintSelectionDiv.style.display === 'none') {
        sprintSelectionDiv.style.display = 'block';
      } else {
        sprintSelectionDiv.style.display = 'none';
      }
    });
  </script>



</section>






<!-- ---------------------------------- -->
<!-- Discussion List -->
<!-- ---------------------------------- -->

<section class="two-column-section">
  <div class="column-wide section">
    {# <h3>Needs Discussion <span style="color:gray; font-weight:200;">({{ projects|count }})</span></h3> #}
    <div class="section-header collapsible-header" onclick="toggleDiscussionSection()">
      <section class="section tabbed-section">
        <div class="tabs">
          <button class="tab-btn active" data-tab="discussion">For Discussion</button>
          <button class="tab-btn" data-tab="backlog">Backlog</button>
        </div>
        {# </div> #}

        <div class="discussion-list" id="discussion-list">
          {% for project in projects|selectattr('location', '==', "discussion") %}
          <div class="discussion-item" data-project-id="{{ project.id }}">
            <p><strong>{{ project.name }}</strong><br>
              <span class="discussion-details">{{ project.context }}</span>
            </p>
            <div class="discussion-actions">
              <span class="requester date-badge">{{ project.dri }}</span> <span class="date-badge">{{ project.created.strftime('%b %d, %Y') }}</span>
              <button class="btn-text">Discuss</button>
              <a href="{{ url_for('edit', project_id=project.id) }}" class="btn-icon" title="Edit project"><button class="btn-text">Edit</button></a>
              <button class="btn-text">Commit to Sprint</button>
              <button class="btn-text">Move to Backlog</button>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="tab-content" id="backlog-tab">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Led by</th>
                  <th>Completed</th>
                  <th>Sprint</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for project in projects|selectattr('location', '==', "completed") %}
                <tr>
                  <td><a href="{{ url_for('project', project_id=project['id']) }}">{{ project.name }}</a></td>
                  <td>{{ project.dri }} <span class="team-tag">{{ project.team }}</span></td>
                  <td>{{ project.created }}</td>
                  <td>
                    <span class="priority-indicator 
                {% if project.priority == 'High' %}priority-high
                {% elif project.priority == 'Medium' %}priority-medium
                {% else %}priority-low{% endif %}">
                      {{ project.priority|default('Medium') }}
                    </span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <a href="{{ url_for('edit', project_id=project.id) }}" class="btn-icon" title="Edit project">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                      </a>
                      <a href="#" class="btn-icon" title="Move to discussion">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="12" cy="12" r="10"></circle>
                          <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                      </a>
                      <a href="{{url_for('add_to_cycle', project_id=project.id, sprint_id=2) }}" class="btn-icon" title="Add to Sprint">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                          <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                      </a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>










      {# 
    <div class="header-actions">
      <a href="{{ url_for('createProject') }}" class="btn-icon" title="Add new Goal">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </a>
      <span class="collapse-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </span>
    </div>
  </div>

  <div class="discussion-list" id="discussion-list">
    {% for project in projects|selectattr('location', '==', "discussion") %}
    <div class="discussion-item" data-project-id="{{ project.id }}">
      <p><strong>{{ project.name }}</strong><br>
        <span class="discussion-details">{{ project.context }}</span>
      </p>
      <div class="discussion-actions">
        <span class="requester date-badge">{{ project.dri }}</span> <span class="date-badge">{{ project.created.strftime('%b %d, %Y') }}</span>
        <button class="btn-text">Discuss</button>
        <a href="{{ url_for('edit', project_id=project.id) }}" class="btn-icon" title="Edit project"><button class="btn-text">Edit</button></a>
        <button class="btn-text">Commit to Sprint</button>
        <button class="btn-text">Move to Backlog</button>
      </div>
    </div>
    {% endfor %}

    {% for goal in goals %}
    <div class="discussion-item" data-project-id="{{ goal.id }}">
      <div class="discussion-meta">


      </div>
      <h4>{{ goal.title }}</h4>
      <p class="discussion-details">{{ goal.details }}</p>
      <div class="discussion-actions">
        <span class="requester date-badge">{{ goal.requested_by }}</span> <span class="date-badge">{{ goal.created.strftime('%Y.%m.%d') }}</span>
        <button class="btn-text">Discuss</button>
        <button class="btn-text">Move to Sprint</button>
        <button class="btn-text">Move to Backlog</button>
      </div>
    </div>
    {% endfor %}
  </div>
  #}
    </div>
  </div>
  <div class="column-narrow section">
    <div class="section-header">
      <h3>Objectives</h3>
      <a href="{{ url_for('createGoal') }}" class="btn-icon" title="Add new Goal">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </a>
    </div>

    <div class="goals-list">
      {% for goal in goals %}
      <div class="goal-item">
        <h4>{{ goal.title }}</h4>
        <p>{{ goal.details }}</p>
      </div>
      {% endfor %}
    </div>
</section>


<!-- ---------------------------------- -->
<!-- Current Sprint and Goals -->
<!-- ---------------------------------- -->
<section class="section discussion-section">
  <div class="column-wide section">
    <div class="section-header">
      <h3>Cycle Commitments</h3>
      <span class="status-badge status-planned">
        {% if sprints|length > 0 %}
        {{ sprints[0].date_start.strftime('%b %d, %Y') }} &rarr; {{ sprints[0].date_end.strftime('%b %d, %Y') }}
        {% endif %}
      </span>
    </div>

    <div class="sprint-projects">
      <style>

      </style>

      <div class="dual-timelines">
        <!-- Project Progress Timeline -->
        <div class="timeline-box">
          <div class="timeline-title">‚úî Commitments Completed</div>

          {% set done_count = sprintlog|selectattr('status', '==', "Done")|list|length %}
          {% set total_count = sprintlog|count %}
          {% if total_count > 0 %}
          {% set percentage_projects = (done_count / total_count) * 100 %}
          {% else %}
          {% set percentage_projects = 0 %}
          {% endif %}

          <div class="container-progress-full">
            <div class="container-progress" style="width: {{ percentage_projects }}%;"></div>
            <span class="progress-text">
              {{ done_count }} out of {{ total_count }} Projects
            </span>
          </div>
        </div>

        <!-- Sprint Time Progress Timeline -->
        <div class="timeline-box">
          <div class="timeline-title"> ‚è≤ Cycle Time Remaining</div>

          {% set sprint = sprints[0] %}
          {% set start_date = sprint.date_start %}
          {% set end_date = sprint.date_end %}
          {% set today_date = today.date() %}

          {% set total_days = (end_date - start_date).days %}
          {% if total_days <= 0 %}{% set total_days = 1 %}{% endif %}

          {% set days_elapsed = (today_date - start_date).days %}
          {% set percentage_time = (days_elapsed / total_days) * 100 %}
          {% if percentage_time > 100 %}
          {% set percentage_time = 100 %}
          {% elif percentage_time < 0 %}
          {% set percentage_time = 0 %}
          {% endif %}

          <div class="timeline-progress-full">
            <div class="timeline-progress" style="width: {{ percentage_time }}%;"></div>
            <span class="timeline-text">
              {% set days_remaining = total_days - days_elapsed %}
              {% if days_remaining > 0 %}
              {{ days_remaining }} days remaining
                {% elif days_remaining == 0 %}
                    Last day of sprint
                {% else %}
                    Sprint ended
                {% endif %}
            </span>
          </div>
        </div>
      </div>

      <hr>

      <div class="timeline-title">üë®‚Äçüíª Projects</div>

      <!-- Sortable projects list -->
      <div id="sortable-projects" class="sortable-projects">
        {% for entry in sprintlog %}
        {% set project = entry.project %}
        <div class="project-item" data-id="{{ entry.id }}" data-project-id="{{ project.id }}" data-order="{{ entry.order }}">
          <div class="project-header">
            <span class="drag-handle">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="9" cy="5" r="1"></circle>
                <circle cx="9" cy="12" r="1"></circle>
                <circle cx="9" cy="19" r="1"></circle>
                <circle cx="16" cy="5" r="1"></circle>
                <circle cx="16" cy="12" r="1"></circle>
                <circle cx="16" cy="19" r="1"></circle>
              </svg>
            </span>
            <h5><a href="{{ url_for('project', project_id=project.id) }}">{{ project.name }}</a></h5>
            {% if entry.critical %}
            <span class="critical-badge">Critical</span>
            {% endif %}
            <span class="critical-toggle {% if entry.critical %}active{% endif %}" data-id="{{ entry.id }}" title="Mark as critical">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="{% if entry.critical %}currentColor{% else %}none{% endif %}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg>
            </span>
            <span class="status-badge 
            {% if entry.status == 'In Progress' %}status-in-progress
            {% elif entry.status == 'Done' %}status-complete
            {% elif entry.status == 'Blocked' %}status-blocked
            {% else %}status-planned{% endif %}">
              {{ entry.status|default('Planned') }}
            </span>
          </div>
          <div class="project-meta">
            <p><strong>Priority:</strong> {{ entry.order }}<br>
              <strong>Goal:</strong> {{ entry.goal }}
              <br><strong>Lead:</strong> <span class="project-team">{{ project.dri }} / {{ project.team }}</span>
            </p>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</section>

<!-- Add Sortable.js library from CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
{# 
<!-- Add our custom script for sortable functionality and critical toggle -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Sortable for project reordering
    const projectsList = document.getElementById('sortable-projects');

    if (projectsList && projectsList.children.length > 0) {
      const sortable = new Sortable(projectsList, {
        animation: 150,
        handle: '.drag-handle',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        onEnd: function(evt) {
          updateProjectOrder();
        }
      });

      // Function to get all projects and their new order
      function updateProjectOrder() {
        const projects = document.querySelectorAll('#sortable-projects .project-item');
        const orderData = [];

        projects.forEach((project, index) => {
          orderData.push({
            id: project.dataset.id,
            order: index + 1
          });
        });

        // Send the new order to the server
        fetch('/api/projects/reorder', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
              projects: orderData
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showNotification('Project order updated successfully', 'success');
            } else {
              showNotification('Failed to update project order', 'error');
            }
          })
          .catch(error => {
            console.error('Error updating project order:', error);
            showNotification('Error updating project order', 'error');
          });
      }

      // Add event listeners for critical toggle buttons
      const criticalToggles = document.querySelectorAll('.critical-toggle');
      criticalToggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
          const id = this.dataset.id;
          const isCurrentlyActive = this.classList.contains('active');
          const newCriticalState = !isCurrentlyActive;

          // Toggle the visual state immediately for better UX
          this.classList.toggle('active');

          // Update the icon fill
          const starIcon = this.querySelector('svg');
          if (starIcon) {
            starIcon.setAttribute('fill', newCriticalState ? 'currentColor' : 'none');
          }

          // Add or remove the critical badge
          const projectItem = this.closest('.project-item');
          const existingBadge = projectItem.querySelector('.critical-badge');

          if (newCriticalState && !existingBadge) {
            const badge = document.createElement('span');
            badge.className = 'critical-badge';
            badge.textContent = 'Critical';
            projectItem.querySelector('.project-header').insertBefore(
              badge,
              projectItem.querySelector('.status-badge')
            );
          } else if (!newCriticalState && existingBadge) {
            existingBadge.remove();
          }

          // Send the update to the server
          fetch('/api/project/toggle_critical', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
              },
              body: JSON.stringify({
                sprintProjectId: id,
                critical: newCriticalState
              })
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                showNotification(
                  newCriticalState ? 'Project marked as critical' : 'Project unmarked as critical',
                  'success'
                );
              } else {
                // Revert the visual change if the server update failed
                this.classList.toggle('active');
                if (starIcon) {
                  starIcon.setAttribute('fill', !newCriticalState ? 'currentColor' : 'none');
                }
                if (!newCriticalState && !existingBadge) {
                  const badge = document.createElement('span');
                  badge.className = 'critical-badge';
                  badge.textContent = 'Critical';
                  projectItem.querySelector('.project-header').insertBefore(
                    badge,
                    projectItem.querySelector('.status-badge')
                  );
                } else if (newCriticalState && existingBadge) {
                  existingBadge.remove();
                }
                showNotification('Failed to update project status', 'error');
              }
            })
            .catch(error => {
              console.error('Error updating critical status:', error);
              // Revert the visual change if there was an error
              this.classList.toggle('active');
              if (starIcon) {
                starIcon.setAttribute('fill', !newCriticalState ? 'currentColor' : 'none');
              }
              if (!newCriticalState && !existingBadge) {
                const badge = document.createElement('span');
                badge.className = 'critical-badge';
                badge.textContent = 'Critical';
                projectItem.querySelector('.project-header').insertBefore(
                  badge,
                  projectItem.querySelector('.status-badge')
                );
              } else if (newCriticalState && existingBadge) {
                existingBadge.remove();
              }
              showNotification('Error updating project status', 'error');
            });
        });
      });
    }
  });
</script>


<!-- Tabbed section -->

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Existing tab functionality
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Remove active class from all buttons and contents
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));

        // Add active class to clicked button and corresponding content
        button.classList.add('active');
        const tabId = button.getAttribute('data-tab');
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });

    // Initialize dark mode from localStorage
    if (localStorage.getItem('darkMode') === 'enabled') {
      document.body.classList.add('dark-mode');
    }

    // Modal functionality
    const modal = document.getElementById('projectModal');
    const closeModalBtn = document.querySelector('.close-modal');
    const discussButtons = document.querySelectorAll('.discussion-actions .btn-text');

    // Set up event listeners for discuss buttons
    discussButtons.forEach(button => {
      if (button.textContent.trim() === 'Discuss') {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          const projectItem = this.closest('.discussion-item');
          const projectId = projectItem.dataset.projectId;
          openProjectModal(projectId);
        });
      }
    });

    // Close modal when clicking the √ó button
    closeModalBtn.addEventListener('click', function() {
      closeModal();
    });

    // Close modal when clicking outside the modal
    window.addEventListener('click', function(event) {
      if (event.target === modal) {
        closeModal();
      }
    });

    // Handle "Move to Sprint" button
    const moveToSprintBtn = document.getElementById('btn-move-sprint');
    const confirmSprintBtn = document.getElementById('btn-confirm-sprint');
    const cancelBtn = document.getElementById('btn-cancel');
    const sprintGoalContainer = document.getElementById('sprint-goal-container');

    moveToSprintBtn.addEventListener('click', function() {
      // Show sprint goal input and confirm/cancel buttons
      sprintGoalContainer.style.display = 'block';
      confirmSprintBtn.style.display = 'inline-block';
      cancelBtn.style.display = 'inline-block';
      // Hide action buttons
      moveToSprintBtn.style.display = 'none';
      document.getElementById('btn-edit').style.display = 'none';
      document.getElementById('btn-move-backlog').style.display = 'none';
    });

    cancelBtn.addEventListener('click', function() {
      // Reset modal to normal state
      resetModalButtons();
    });

    confirmSprintBtn.addEventListener('click', function() {
      const projectId = modal.dataset.projectId;
      const sprintGoal = document.getElementById('sprint-goal').value;

      if (!sprintGoal.trim()) {
        alert('Please enter a sprint goal before confirming.');
        return;
      }

      // Submit the data to move the project to sprint
      moveProjectToSprint(projectId, sprintGoal);
    });

    // Set up event listeners for other action buttons
    document.getElementById('btn-edit').addEventListener('click', function() {
      const projectId = modal.dataset.projectId;
      window.location.href = `project/${projectId}/edit/`;
    });

    document.getElementById('btn-move-backlog').addEventListener('click', function() {
      const projectId = modal.dataset.projectId;
      moveProjectToBacklog(projectId);
    });
  });

  // Function to open the modal and load project details
  function openProjectModal(projectId) {
    const modal = document.getElementById('projectModal');
    modal.dataset.projectId = projectId;

    // Show the modal
    modal.style.display = 'block';

    // Fetch project details via AJAX
    fetchProjectDetails(projectId);
  }

  // Function to close the modal
  function closeModal() {
    const modal = document.getElementById('projectModal');
    modal.style.display = 'none';
    resetModalButtons();

    // Clear the sprint goal input
    document.getElementById('sprint-goal').value = '';
  }

  // Reset modal buttons to their default state
  function resetModalButtons() {
    document.getElementById('sprint-goal-container').style.display = 'none';
    document.getElementById('btn-confirm-sprint').style.display = 'none';
    document.getElementById('btn-cancel').style.display = 'none';

    document.getElementById('btn-move-sprint').style.display = 'inline-block';
    document.getElementById('btn-edit').style.display = 'inline-block';
    document.getElementById('btn-move-backlog').style.display = 'inline-block';
  }

  // Function to fetch project details from server
  function fetchProjectDetails(projectId) {
    fetch(`/api/project/${projectId}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(project => {
        // Populate modal with project details
        document.getElementById('modal-title').textContent = "Project Details";
        document.getElementById('modal-project-title').textContent = project.name;
        document.getElementById('modal-project-details').textContent = project.details || 'No details provided';
        document.getElementById('modal-project-context').textContent = project.context || 'No context provided';
        document.getElementById('modal-project-requirements').textContent = project.requirements || 'No requirements specified';
        document.getElementById('modal-project-dri').textContent = project.dri || 'Unassigned';
        document.getElementById('modal-project-created').textContent = project.created || '';
      })
      .catch(error => {
        console.error('Error fetching project details:', error);
        alert('Failed to load project details. Please try again.');
        closeModal();
      });
  }

  // Function to move project to sprint
  function moveProjectToSprint(projectId, sprintGoal) {
    const data = {
      projectId: projectId,
      sprintGoal: sprintGoal,
      location: 'sprint'
    };

    fetch('/api/project/move', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(result => {
        if (result.success) {
          // Close the modal and refresh the page to show updated data
          closeModal();
          window.location.reload();
        } else {
          alert(result.message || 'Failed to move project to sprint.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your request.');
      });
  }

  // Function to move project to backlog
  function moveProjectToBacklog(projectId) {
    const data = {
      projectId: projectId,
      location: 'backlog'
    };

    fetch('/api/project/move', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(result => {
        if (result.success) {
          // Close the modal and refresh the page to show updated data
          closeModal();
          window.location.reload();
        } else {
          alert(result.message || 'Failed to move project to backlog.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your request.');
      });
  }

  // Toggle discussion section
  function toggleDiscussionSection() {
    const header = document.querySelector('.discussion-section .section-header');
    const content = document.getElementById('discussion-list');

    header.classList.toggle('collapsed');

    if (header.classList.contains('collapsed')) {
      content.style.display = 'none';
    } else {
      content.style.display = 'block';
    }
  }

  // Toggle dark mode
  function toggleDarkMode() {
    const body = document.body;

    body.classList.toggle('dark-mode');

    // Save preference to localStorage
    if (body.classList.contains('dark-mode')) {
      localStorage.setItem('darkMode', 'enabled');
    } else {
      localStorage.setItem('darkMode', 'disabled');
    }
  }
  // Add this script to the bottom of the page (before the closing body tag)

  document.addEventListener('DOMContentLoaded', function() {
    // Get elements
    const createSprintBtn = document.getElementById('create-sprint-btn');
    const createSprintForm = document.getElementById('create-sprint-form');
    const cancelCreateBtn = document.getElementById('cancel-create');
    const selectDropdownSprintBtn = document.getElementById('select-dropdown-sprint');
    // const sprintDropdown = document.getElementById('sprint-dropdown');
    const currentSelection = document.getElementById('current-selection');
    const selectedSprintTitle = document.getElementById('selected-sprint-title');
    const selectedSprintDates = document.getElementById('selected-sprint-dates');
    const changeSprintBtn = document.getElementById('change-sprint-btn');
    const sprintSelectionOptions = document.querySelectorAll('.sprint-selection-option');

    // Check if there's already a selected sprint in session storage
    const storedSprintId = sessionStorage.getItem('selectedSprintId');
    const storedSprintTitle = sessionStorage.getItem('selectedSprintTitle');
    const storedSprintDates = sessionStorage.getItem('selectedSprintDates');

    if (storedSprintId && storedSprintTitle) {
      // Hide selection options and show current selection
      sprintSelectionOptions.forEach(option => {
        option.style.display = 'none';
      });
      selectedSprintTitle.textContent = storedSprintTitle;
      selectedSprintDates.textContent = storedSprintDates;
      currentSelection.style.display = 'block';

      // Update any relevant UI elements with the selected sprint
      updateUIWithSelectedSprint(storedSprintId);
    }

    // Show create sprint form
    createSprintBtn.addEventListener('click', function() {
      sprintSelectionOptions.forEach(option => {
        option.style.display = 'none';
      });
      createSprintForm.style.display = 'block';

      // Set default dates
      const today = new Date();
      const twoWeeksLater = new Date(today);
      twoWeeksLater.setDate(today.getDate() + 14);

      document.getElementById('date_start').valueAsDate = today;
      document.getElementById('date_end').valueAsDate = twoWeeksLater;
    });

    // Cancel create sprint
    cancelCreateBtn.addEventListener('click', function() {
      createSprintForm.style.display = 'none';
      sprintSelectionOptions.forEach(option => {
        option.style.display = 'block';
      });
    });

    // Handle form submission with AJAX
    const sprintForm = document.getElementById('sprint-form');
    sprintForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const formData = new FormData(this);

      fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Store the new sprint info in session storage
            sessionStorage.setItem('selectedSprintId', data.sprint.id);
            sessionStorage.setItem('selectedSprintTitle', data.sprint.title);
            sessionStorage.setItem('selectedSprintDates',
              `${new Date(data.sprint.date_start).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})} - 
           ${new Date(data.sprint.date_end).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`);

            // Update the UI
            selectedSprintTitle.textContent = data.sprint.title;
            selectedSprintDates.textContent = `${new Date(data.sprint.date_start).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})} - 
                                           ${new Date(data.sprint.date_end).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
            createSprintForm.style.display = 'none';
            currentSelection.style.display = 'block';

            // Update relevant UI elements
            updateUIWithSelectedSprint(data.sprint.id);

            // Show success message
            showNotification('Sprint created and selected successfully!', 'success');
          } else {
            showNotification('Error creating sprint: ' + data.message, 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showNotification('An error occurred. Please try again.', 'error');
        });
    });

    // Select sprint from dropdown
    selectDropdownSprintBtn.addEventListener('click', function() {
      const selectedSprintId = sprintDropdown.value;
      if (!selectedSprintId) {
        showNotification('Please select a sprint from the dropdown', 'error');
        return;
      }

      const selectedOption = sprintDropdown.options[sprintDropdown.selectedIndex];
      const sprintTitle = selectedOption.text;

      // Store selected sprint in session storage
      sessionStorage.setItem('selectedSprintId', selectedSprintId);
      sessionStorage.setItem('selectedSprintTitle', sprintTitle);

      // Update UI
      selectedSprintTitle.textContent = sprintTitle;
      sprintSelectionOptions.forEach(option => {
        option.style.display = 'none';
      });
      currentSelection.style.display = 'block';

      // Update relevant UI elements
      updateUIWithSelectedSprint(selectedSprintId);

      showNotification('Sprint selected successfully!', 'success');
    });

    // Select recommended sprint button handler
    document.querySelectorAll('.select-sprint-btn').forEach(button => {
      button.addEventListener('click', function() {
        const sprintId = this.getAttribute('data-sprint-id');
        const sprintCard = this.closest('.sprint-card');
        const sprintTitle = sprintCard.querySelector('strong').textContent;
        const sprintDates = sprintCard.querySelector('.sprint-dates').textContent;

        // Store in session storage
        sessionStorage.setItem('selectedSprintId', sprintId);
        sessionStorage.setItem('selectedSprintTitle', sprintTitle);
        sessionStorage.setItem('selectedSprintDates', sprintDates);

        // Update UI
        selectedSprintTitle.textContent = sprintTitle;
        selectedSprintDates.textContent = sprintDates;
        sprintSelectionOptions.forEach(option => {
          option.style.display = 'none';
        });
        currentSelection.style.display = 'block';

        // Update relevant UI elements
        updateUIWithSelectedSprint(sprintId);

        showNotification('Recommended sprint selected!', 'success');
      });
    });

    // Change sprint button handler
    changeSprintBtn.addEventListener('click', function() {
      currentSelection.style.display = 'none';
      sprintSelectionOptions.forEach(option => {
        option.style.display = 'block';
      });

      // Clear stored sprint
      sessionStorage.removeItem('selectedSprintId');
      sessionStorage.removeItem('selectedSprintTitle');
      sessionStorage.removeItem('selectedSprintDates');
    });

    // Function to update UI elements with selected sprint
    function updateUIWithSelectedSprint(sprintId) {
      // Update all "Add to Sprint" buttons to use the selected sprint ID
      document.querySelectorAll('.btn-text').forEach(button => {
        if (button.textContent === 'Commit to Sprint' || button.textContent === 'Move to Sprint') {
          // Update the button's sprint-related attributes
          button.setAttribute('data-sprint-id', sprintId);
        }
      });

      // Update the sprint details section to show selected sprint's data
      fetchSprintDetails(sprintId);
    }

    // Function to fetch sprint details and update the UI
    function fetchSprintDetails(sprintId) {
      fetch(`/api/sprint/${sprintId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update the sprint commitments section
            updateSprintCommitments(data.sprint);
          }
        })
        .catch(error => {
          console.error('Error fetching sprint details:', error);
        });
    }

    // Function to update the sprint commitments section
    function updateSprintCommitments(sprint) {
      const commitmentSection = document.querySelector('.sprint-projects');
      // Update title and date range
      const sectionHeader = document.querySelector('.section-header .status-badge');
      if (sectionHeader) {
        sectionHeader.textContent = `${new Date(sprint.date_start).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})} ‚Üí ${new Date(sprint.date_end).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
      }

      // If the sprint has projects, refresh the list
      if (sprint.projects && sprint.projects.length > 0) {
        // Update project counts and progress bars
        updateProgressBars(sprint);
      }
    }

    // Function to update progress bars in the commitments section
    function updateProgressBars(sprint) {
      if (!sprint.projects) return;

      const doneCount = sprint.projects.filter(p => p.status === 'Done').length;
      const totalCount = sprint.projects.length;
      const percentageProjects = totalCount > 0 ? (doneCount / totalCount) * 100 : 0;

      // Update project completion progress bar
      const projectProgressBar = document.querySelector('.container-progress');
      const projectProgressText = document.querySelector('.progress-text');

      if (projectProgressBar) {
        projectProgressBar.style.width = `${percentageProjects}%`;
      }

      if (projectProgressText) {
        projectProgressText.textContent = `${doneCount} out of ${totalCount} Projects`;
      }
    }

    // Helper function to show notifications
    function showNotification(message, type) {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;

      // Add to document
      document.body.appendChild(notification);

      // Remove after 3 seconds
      setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 500);
      }, 3000);
    }
  });

  // When opening the modal, initialize with selected sprint
  function openProjectModal(projectId) {
    const modal = document.getElementById('projectModal');
    modal.dataset.projectId = projectId;

    // Show the modal
    modal.style.display = 'block';

    // Get selected sprint from session storage
    const selectedSprintId = sessionStorage.getItem('selectedSprintId');
    const selectedSprintTitle = sessionStorage.getItem('selectedSprintTitle');

    // Store selected sprint ID in modal data attribute
    if (selectedSprintId) {
      modal.dataset.sprintId = selectedSprintId;

      // Update the sprint title in the modal
      const modalSprintTitle = document.getElementById('modal-sprint-title');
      if (modalSprintTitle) {
        modalSprintTitle.textContent = selectedSprintTitle;
      }
    } else {
      // If no sprint is selected, disable the "Commit to Sprint" button
      const moveToSprintBtn = document.getElementById('btn-move-sprint');
      if (moveToSprintBtn) {
        moveToSprintBtn.disabled = true;
        moveToSprintBtn.title = "Please select a sprint first";
      }
    }

    // Fetch project details via AJAX
    fetchProjectDetails(projectId);
  }

  // Update the moveToSprintBtn click handler
  document.getElementById('btn-move-sprint').addEventListener('click', function() {
    const modal = document.getElementById('projectModal');
    const selectedSprintId = modal.dataset.sprintId;

    if (!selectedSprintId) {
      showNotification('Please select a sprint first before committing a project.', 'error');
      return;
    }

    // Show sprint goal input and confirm/cancel buttons
    document.getElementById('sprint-goal-container').style.display = 'block';
    document.getElementById('btn-confirm-sprint').style.display = 'inline-block';
    document.getElementById('btn-cancel').style.display = 'inline-block';

    // Hide action buttons
    this.style.display = 'none';
    document.getElementById('btn-edit').style.display = 'none';
    document.getElementById('btn-move-backlog').style.display = 'none';
  });

  // Update the confirmSprintBtn click handler
  document.getElementById('btn-confirm-sprint').addEventListener('click', function() {
    const modal = document.getElementById('projectModal');
    const projectId = modal.dataset.projectId;
    const sprintId = modal.dataset.sprintId;
    const sprintGoal = document.getElementById('sprint-goal').value;

    if (!sprintGoal.trim()) {
      showNotification('Please enter a sprint goal before confirming.', 'error');
      return;
    }

    // Submit the data to commit the project to the selected sprint
    commitProjectToSprint(projectId, sprintId, sprintGoal);
  });

  // New function to commit a project to the selected sprint
  function commitProjectToSprint(projectId, sprintId, goal) {
    const data = {
      projectId: projectId,
      sprintId: sprintId,
      goal: goal
    };

    fetch('/api/project/commit_to_sprint', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(result => {
        if (result.success) {
          // Close the modal
          closeModal();

          // Show success message
          showNotification('Project committed to sprint successfully!', 'success');

          // Refresh the sprint commitments section
          fetchSprintDetails(sprintId);

          // Remove the project from the discussion list
          const projectItem = document.querySelector(`.discussion-item[data-project-id="${projectId}"]`);
          if (projectItem) {
            projectItem.classList.add('fade-out');
            setTimeout(() => {
              projectItem.remove();
            }, 500);
          }
        } else {
          showNotification(result.message || 'Failed to commit project to sprint.', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while processing your request.', 'error');
      });
  }

  // Helper function to show notifications
  function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;

    // Add to document
    document.body.appendChild(notification);

    // Remove after 3 seconds
    setTimeout(() => {
      notification.classList.add('fade-out');
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 500);
    }, 3000);
  }
</script>

<!-- Project Details Modal -->
<div id="projectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-title">Project Details</h3>
      <span class="close-modal">&times;</span>
    </div>
    <div class="modal-body">
      <div class="project-info">
        <div class="info-group">
          <label>Title:</label>
          <p id="modal-project-title"></p>
        </div>
        <div class="info-group">
          <label>Details:</label>
          <p id="modal-project-details"></p>
        </div>
        <div class="info-group">
          <label>Context:</label>
          <p id="modal-project-context"></p>
        </div>
        <div class="info-group">
          <label>Requirements:</label>
          <p id="modal-project-requirements"></p>
        </div>
        <div class="info-group">
          <label>DRI:</label>
          <p id="modal-project-dri"></p>
        </div>
        <div class="info-group">
          <label>Created:</label>
          <p id="modal-project-created"></p>
        </div>
      </div>

      <!-- Sprint Goal Input (hidden by default) -->
      <div id="sprint-goal-container" class="sprint-goal-container" style="display: none;">
        <div class="sprint-selection-info">
          <p>Committing to: <strong id="modal-sprint-title"></strong></p>
        </div>
        <label for="sprint-goal">Sprint Goal:</label>
        <textarea id="sprint-goal" class="form-control" rows="3" placeholder="Define the sprint goal for this project"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button id="btn-edit" class="btn btn-secondary">Edit</button>
      <button id="btn-move-backlog" class="btn btn-secondary">Move to Backlog</button>
      <button id="btn-move-sprint" class="btn btn-primary">Commit to Sprint</button>
      <button id="btn-confirm-sprint" class="btn btn-success" style="display: none;">Confirm</button>
      <button id="btn-cancel" class="btn btn-text" style="display: none;">Cancel</button>
    </div>
  </div>
</div>

#}

{% endblock %}